<!DOCTYPE html>
<html>
<head>
<script>

/*the doExport() function that is trigger onclick here is passed to the master script
notice I make sure doExport will execute in context of this document by attaching it to
'this'. I take advantage of the fact that until I execute doExport the reference to structureJS 
is not resolved. This avoids refernce errors because I could not guarantee structureJS would
be loaded on time. There is obviously a better way to do this like maybe writing a mini script loaded
here that would execute master script then the logic contained here (in a file) next. Truthfully,
is works so I'm just going to leave it for now*/
function _$(idORClass){
  idORClass = removeHash(idORClass)
  var node = null;
  if(idORClass instanceof Node)
    node = idORClass;
  else
    node = document.getElementById(idORClass);

  return node;
}

function removeHash(str){
  var returnVal = str;
  if(str[0] == '#')
    returnVal = str.substr(1);
  return returnVal;
  
}

/*structureJS API*/
var _projectData = {};
var doExport = null;

window.sjsOnComplete = {};
window.sjsOnComplete.projectManagerContext = this;
window.sjsOnComplete.bind = function(){
  
  window.sjsOnComplete.projectManagerContext.doExport = function(){
    var exportData = {};
    exportData.files =  _$('target').value || '';
    exportData.base_dir =  _$('project_location').value || './';
    exportData.manifest_loc =  _$('project_manifest_location').value || './';
    exportData.manifest_name =  _$('project_manifest_name').value || 'manifest';
    
    structureJS.exportLoadData(exportData);
    if(structureJS.exportInitiated == false){
      structureJS.exportInit();
    }else{
      structureJS.exportUpdate();
    }
  }
  
};



/*Project Stroe Operations*/
function initProjectStore(){
  var projectStore = {}
  projectStore.projects = {};
  projectStore.lastOpened = '';
  if(typeof localStorage['project_store'] == 'undefined'){
    localStorage['project_store'] = JSON.stringify(projectStore);
  }else{
    /*Have last project opened on startup*/
    loadProject( getStore().lastOpened );
  }
}
function getProjectStore(){
  return JSON.parse(localStorage['project_store']).projects;
}
function getStore(){
  return JSON.parse(localStorage['project_store']);
}
function setStore(store){
  localStorage['project_store'] = JSON.stringify(store);
}
function addProject(projectObj){
  var store = getStore();
  store.projects[projectObj.project_name] = projectObj;
  setStore(store);
  
}
function deleteProject(projectName){
  var store = getStore();
  
  if(projectName !== '' && typeof store.projects[projectName] != 'undefined'){
    delete store.projects[projectName];
    setStore(store);
  }else{
    notifyUser('Project Name Not Recognized');
  }
}


/*Project Retrieval & Manip*/

function getProjectNames(){
  var store = getProjectStore();
  var names = [];
  for(var name in store){
    names.push(name);
  }
  return names;
}

function loadProject(name){
  var store = getProjectStore();
  var project = store[name];
  if(typeof project != 'undefined'){
    /*Repopulate fields*/
    for(var inputName in project){
      _$(inputName).value = project[inputName];
    }
    var store = getStore();
    store.lastOpened = name;
    setStore( store );
  }
  
}

function saveProject(){
  
  _projectData.project_name = _$('project_name').value || '';
  _projectData.target = _$('target').value || '';
  _projectData.project_location =  _$('project_location').value || './';
  _projectData.project_manifest_location =  _$('project_manifest_location').value || './';
  _projectData.project_manifest_name =  _$('project_manifest_name').value || 'manifest';
  
  if(_projectData.name == ''){
    notifyUser('Project Must Have A Name');
    return false;
  }
  addProject(_projectData);
  updateSelect('#delete_select');
  updateSelect('#load_select');
}

/*Select Manip*/
function clearSelect(id){
  var select = _$(id);
  var options = select.childNodes;
  for(var i = 0; i < options.length; i++){
    options[i].parentNode.removeChild(options[i]);
    i--;
  }

}
function updateSelect(id){
  //Remove '#'
  id = removeHash(id);
  clearSelect(id);
  var select = _$(id);
  var pNames = getProjectNames();
  var option = null;

  for(var i = 0; i < pNames.length; i++){
    option = document.createElement('option');
    option.value = pNames[i];
    option.label = pNames[i];
    select.appendChild(option);
  }
}

function notifyUser(msg){
  console.log(msg);
}


/*Project Compiler Driver*/
window.onload = function(){
  initProjectStore();
  updateSelect('#delete_select');
  updateSelect('#load_select');
  
  _$('#delete_project').addEventListener('click', function(){
    deleteProject(_$('#delete_select').value);
    updateSelect('#delete_select');
    updateSelect('#load_select');
  });
  
  _$('load_project').addEventListener('click', function(){
    loadProject(_$('load_select').value);
  });
  
  var saveProjectBtn = _$('save_project');
  saveProjectBtn.addEventListener('click', saveProject);

  
};

</script>
<script id="structureJS" 
        data-config="export-config"
        src="structureJS.js"/>
</script>

</head>
<body>
  <label for="project_location">Project Name: </label><input id="project_name" type="text"></input><br>
  <label for="project_location">Project Base Dir (Relative To This File): </label><input id="project_location" type="text"></input><br>
  <label for="project_manifest_name">Project Maniefest Name: </label><input id="project_manifest_name" type="text"></input> *Leave Blank If It's Named 'maifest'<br>
  <label for="project_manifest_location">Project Maniefest Location (Relative To Project Base Dir): </label><input id="project_manifest_location" type="text"></input><br>
  <label for="target">Target: </label><input id="target" type="text"></input>
  <br><label for="delete_select">Delete Project: </label><select id="delete_select" type="text"></select><button id="delete_project">Go</button>
  <br><label for="load_select">Load Project: </label><select id="load_select" type="text"></select><button id="load_project">Go</button>
  <br><button onclick="doExport()" id="export">Export</button>
  <br><button id="save_project">Save Project</button>
  <div id="minified"></div>
</body>

</html>